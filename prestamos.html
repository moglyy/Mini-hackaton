<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - Lab Instruments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styless.css" rel="stylesheet">
</head>
<body>
    <div id="navbar"></div>

    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-shopping-bag me-3"></i>Gestión de Pedidos</h1>
                    <p class="lead">Control y seguimiento de tus solicitudes de equipos</p>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-handshake fa-4x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-5 g-3" id="statsContainer">
            <div class="col-12 col-sm-6 col-lg-3 d-flex justify-content-center">
                <div class="card card-custom text-center w-100" style="max-width: 280px;">
                    <div class="card-body">
                        <i class="fas fa-list fa-2x text-primary mb-3"></i>
                        <h3 id="totalPedidos" class="mb-2">0</h3>
                        <p class="mb-0">Total Pedidos</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3 d-flex justify-content-center">
                <div class="card card-custom text-center w-100" style="max-width: 280px; background: rgba(255, 193, 7, 0.1);">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <h3 id="pendientePedidos" class="mb-2">0</h3>
                        <p class="mb-0">Pendientes</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3 d-flex justify-content-center">
                <div class="card card-custom text-center w-100" style="max-width: 280px; background: rgba(40, 167, 69, 0.1);">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                        <h3 id="confirmadoPedidos" class="mb-2">0</h3>
                        <p class="mb-0">Confirmados</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3 d-flex justify-content-center">
                <div class="card card-custom text-center w-100" style="max-width: 280px; background: rgba(220, 53, 69, 0.1);">
                    <div class="card-body">
                        <i class="fas fa-times-circle fa-2x text-danger mb-3"></i>
                        <h3 id="canceladoPedidos" class="mb-2">0</h3>
                        <p class="mb-0">Cancelados</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-custom mb-4" id="formPedido" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Crear Nuevo Pedido</h5>
            </div>
            <div class="card-body">
                <form id="pedidoForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Equipo Solicitado *</label>
                            <select class="form-select" id="instrumento_id" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cantidad *</label>
                            <input type="number" class="form-control" id="cantidad" min="1" value="1" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Solicitar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card card-custom">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historial de Pedidos</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="cargarPedidos()">Actualizar</button>
            </div>
            <div class="card-body">
                <div id="loadingPedidos" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Cargando pedidos...</p>
                </div>
                <div class="table-responsive" id="tablaPedidosContainer" style="display: none;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Equipo</th>
                                <th>Cantidad</th>
                                <th>Proveedor/Cliente</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidosBody"></tbody>
                    </table>
                </div>
                <div id="noPedidos" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                    <p class="text-muted">No hay pedidos registrados</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let userRole = '';

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const navResponse = await fetch('navbar.html');
                const navHtml = await navResponse.text();
                document.getElementById('navbar').innerHTML = navHtml;

                const userResponse = await fetch('/tipo-usuario');
                if (!userResponse.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const userData = await userResponse.json();
                userRole = userData.tipo_usuario;

                if (userRole === 'cliente') {
                    document.getElementById('formPedido').style.display = 'block';
                    await cargarInstrumentosDisponibles();
                }

                await cargarPedidos();
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function cargarInstrumentosDisponibles() {
            try {
                const response = await fetch('/cliente/catalogo');
                const instrumentos = await response.json();
                const select = document.getElementById('instrumento_id');
                
                while (select.options.length > 1) {
                    select.remove(1);
                }

                instrumentos.forEach(inst => {
                    if (inst.estado === 'DISPONIBLE') {
                        const option = document.createElement('option');
                        option.value = inst.id;
                        option.textContent = inst.nombre + ' - ' + inst.categoria;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarPedidos() {
            try {
                const endpoint = userRole === 'cliente' ? '/cliente/mis-pedidos' : '/proveedor/mis-pedidos';
                const response = await fetch(endpoint);
                
                if (!response.ok) {
                    throw new Error('Error al cargar pedidos');
                }

                const pedidos = await response.json();
                const tbody = document.getElementById('pedidosBody');
                tbody.innerHTML = '';

                if (!Array.isArray(pedidos) || pedidos.length === 0) {
                    document.getElementById('loadingPedidos').style.display = 'none';
                    document.getElementById('noPedidos').style.display = 'block';
                    updateStats([]);
                    return;
                }

                document.getElementById('loadingPedidos').style.display = 'none';
                document.getElementById('tablaPedidosContainer').style.display = 'block';

                pedidos.forEach(pedido => {
                    const row = document.createElement('tr');
                    const fecha = new Date(pedido.created_at).toLocaleDateString('es-ES');
                    const estadoClass = {'PENDIENTE': 'warning', 'CONFIRMADO': 'info', 'ENVIADO': 'success', 'ENTREGADO': 'success', 'CANCELADO': 'danger'}[pedido.estado] || 'secondary';

                    let acciones = '-';
                    if (userRole === 'cliente' && pedido.estado === 'PENDIENTE') {
                        acciones = '<button class="btn btn-sm btn-danger" onclick="cancelarPedido(' + pedido.id + ')">Cancelar</button>';
                    } else if (userRole === 'proveedor') {
                        if (pedido.estado === 'PENDIENTE') {
                            acciones = '<button class="btn btn-sm btn-success" onclick="confirmarPedido(' + pedido.id + ')">Confirmar</button>';
                        } else if (pedido.estado === 'CONFIRMADO') {
                            acciones = '<button class="btn btn-sm btn-primary" onclick="enviarPedido(' + pedido.id + ')">Enviar</button>';
                        }
                    }

                    row.innerHTML = '<td>#' + pedido.id + '</td><td>' + (pedido.instrumento_nombre || '-') + '</td><td>' + pedido.cantidad + '</td><td>' + (userRole === 'cliente' ? (pedido.proveedor_nombre || '-') : (pedido.cliente_nombre || '-')) + '</td><td><span class="badge bg-' + estadoClass + '">' + pedido.estado + '</span></td><td>' + fecha + '</td><td>' + acciones + '</td>';
                    tbody.appendChild(row);
                });

                updateStats(pedidos);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingPedidos').style.display = 'none';
                document.getElementById('noPedidos').style.display = 'block';
            }
        }

        document.getElementById('pedidoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const instrumento_id = parseInt(document.getElementById('instrumento_id').value);
                const cantidad = parseInt(document.getElementById('cantidad').value);

                const response = await fetch('/cliente/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instrumento_id, cantidad })
                });

                if (!response.ok) throw new Error('Error');

                document.getElementById('pedidoForm').reset();
                await cargarPedidos();
                alert('Pedido creado exitosamente');
            } catch (error) {
                alert('Error al crear pedido');
            }
        });

        async function cancelarPedido(id) {
            if (!confirm('¿Cancelar?')) return;
            try {
                await fetch('/cliente/pedidos/' + id + '/cancelar', { method: 'PUT', headers: { 'Content-Type': 'application/json' } });
                await cargarPedidos();
            } catch (error) {
                alert('Error');
            }
        }

        async function confirmarPedido(id) {
            if (!confirm('¿Confirmar?')) return;
            try {
                await fetch('/proveedor/pedidos/' + id + '/confirmar', { method: 'PUT', headers: { 'Content-Type': 'application/json' } });
                await cargarPedidos();
            } catch (error) {
                alert('Error');
            }
        }

        async function enviarPedido(id) {
            if (!confirm('¿Enviar?')) return;
            try {
                await fetch('/proveedor/pedidos/' + id + '/enviar', { method: 'PUT', headers: { 'Content-Type': 'application/json' } });
                await cargarPedidos();
            } catch (error) {
                alert('Error');
            }
        }

        function updateStats(pedidos) {
            document.getElementById('totalPedidos').textContent = pedidos.length;
            document.getElementById('pendientePedidos').textContent = pedidos.filter(p => p.estado === 'PENDIENTE').length;
            document.getElementById('confirmadoPedidos').textContent = pedidos.filter(p => p.estado === 'CONFIRMADO').length;
            document.getElementById('canceladoPedidos').textContent = pedidos.filter(p => p.estado === 'CANCELADO').length;
        }
    </script>
</body>
</html>
